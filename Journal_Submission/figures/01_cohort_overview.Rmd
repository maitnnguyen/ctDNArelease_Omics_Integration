---
title: "Cohort Overview for Multi-omics characterizing ctDNA release"
output: html_notebook
author: Mai TN Nguyen 
---

This notebook visualize the cohort and data used for the study of ctDNA release

### Set up and load data
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
project_dir = '~/PhDStudy/Research/Manuscript/3rdMS_OmicsIntegrate/Pretreat_Omics_Integration/results/figures_Dec25/Main/'
# library
#source('../00_functions.R')
# load data
cohort <- read.delim('../data4submission/ctdna_at_diagnosis.tsv')
clinical_info <- read.delim('../data4submission/ctdna_clinical_data.tsv')

# load tissue omics data
#dna_data <- load()
#rna_data <- load()
```

### Figure 1a and 1b: stratify ctDNA release group - cohort's HRD and treatment info
```{r fig1ab, echo=FALSE, warning=FALSE, fig.width=15, fig.height=6}
df1 <- cohort %>%
  left_join(
    clinical_info |>
      dplyr::rename(disease_detail = histology)
  )
comp1 <- list(c('Benign\n(n=10)','Early\n(n=14)'),
              c('Benign\n(n=10)','III\n(n=85)'),
              c('Benign\n(n=10)','IV\n(n=19)'),
              c('Early\n(n=14)','IV\n(n=19)'),
              c('III\n(n=85)','IV\n(n=19)')
              )
fig1a = df1 |>
  mutate(
    figo = ifelse(stage %in% c('I', 'II'), 'Early', stage),
    ctdna_lev = case_when(
      TF <= thresh1 ~ "low",
      TF > thresh1 & TF <= thresh2 ~ "med",
      TF > thresh2 ~ "high"
    )
  ) |>
  ggplot(aes(x=factor(figo, 
                      labels = c('Benign\n(n=10)',
                                 'Early\n(n=14)',
                                 'III\n(n=85)',
                                 'IV\n(n=19)')),
             y = TF)) +
  geom_boxplot(width=.3,outlier.shape = NA,
               alpha=.4, show.legend = F) + 
  geom_jitter(aes(color=ctdna_lev), 
              size=3, position=position_jitter(0.2)) + 
  stat_compare_means(comparisons = comp1, size = 5,
                     label.y = c(.12,.16,.20,.24, .28) ) +
  geom_hline(yintercept = thresh1, color=list_color[1]) + 
  geom_hline(yintercept = thresh2, color=list_color[3]) + 
  scale_colour_manual(values = c("high" = list_color[3], 
                                 "med" = list_color[2],
                                 "low"=list_color[1])) +
  labs(x='Stages at diagnosis', y ='ctDNA fraction',
       color = 'ctDNA level') + 
  theme_classic() +
  theme(axis.text.x = element_text(size=14,  family = 'Arial', colour = 'black'),
        axis.title = element_text(size=16,  family = 'Arial', colour = 'black'),
        axis.text = element_text(size=14, family = 'Arial', colour = 'black'),
        legend.position = 'none', 
        legend.text = element_text(size=11, family = 'Arial', colour = 'black'),
        legend.title = element_text(size=13, family = 'Arial', colour = 'black')) 

# pie plot between HRD or treatment administered
ctdna_cohort <- df1 |>
  filter(histology!='benign')

fig1b <- ctdna_cohort |>
  mutate(HRD = ifelse(is.na(HRD), 'NA', HRD)) %>%
  dplyr::group_by(HRD) %>%
  dplyr::summarise(n = n()) %>%
  ungroup() %>%
  mutate(prop = n/sum(n),
         label = paste0(n, " (", round(prop*100,0), "%)")) %>%
  as.data.frame() |>
  ggplot(aes(x='',y = prop, fill=HRD)) +
  geom_col(width=1, color='white') +
  geom_label(aes(label = label), size=5,
             position = position_stack(vjust = 0.5),
             show.legend = FALSE,
             color = "black") +
  coord_polar(theta = "y") +
  labs(x = "", y='') +
  theme_void() +
  scale_fill_manual(values = c("HRD" = "#ffa500", "HRP" = "#c39797", 'NA'='grey')) +
  theme(axis.text.x = element_blank(),#element_text(size=14,  family = 'Arial', colour = 'black'),
        axis.title = element_text(size=16,  family = 'Arial', colour = 'black'),
        axis.text = element_text(size=14, family = 'Arial', colour = 'black'),
        legend.position = 'none', 
        legend.text = element_text(size=11, family = 'Arial', colour = 'black'),
        legend.title = element_text(size=13, family = 'Arial', colour = 'black'))

fig1c <- ctdna_cohort |>
  filter(!is.na(HRD)) |>
  ggplot(aes(x = HRD, y = TF)) +
  geom_violin(aes(fill = factor(HRD, levels = c('HRD','HRP'))), 
              alpha = .8) +
  geom_boxplot(width=.1) +
  scale_fill_manual(values = c("HRD" = "#ffa500", "HRP" = "#c39797"))+
  stat_compare_means(label.x.npc = .35, size = 6, label.y.npc = .8,
                     label = '..p..') +
  theme_pubr()+
  labs(x = 'Homologous recombination', y = 'ctDNA fraction') +
  theme(axis.text.x = element_text(size=14,  family = 'Arial', colour = 'black'),
        axis.title = element_text(size=16,  family = 'Arial', colour = 'black'),
        axis.text = element_text(size=14, family = 'Arial', colour = 'black'),
        legend.position = 'none', 
        legend.text = element_text(size=11, family = 'Arial', colour = 'black'),
        legend.title = element_text(size=13, family = 'Arial', colour = 'black'))

fig1d <- ctdna_cohort |>
  #mutate(HRD = ifelse(is.na(HRD), 'NA', HRD)) %>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(n = n()) %>%
  ungroup() %>%
  mutate(prop = n/sum(n),
         label = paste0(n, " (", round(prop*100,0), "%)")) %>%
  as.data.frame() |>
  ggplot(aes(x='',y = prop, fill=factor(treatment, levels = c('PDS','NACT','Other')))) +
  geom_col(width=1, color='white') +
  geom_label(aes(label = label), size=5,
             position = position_stack(vjust = 0.5),
             show.legend = FALSE,
             color = "black") +
  coord_polar(theta = "y") +
  theme_void() +
  labs(x = '', y='') +
  scale_fill_manual(values = c("NACT" = "#744700", "PDS" = "#76a5af", 'Other'='gray')) +
  theme(axis.text.x = element_blank(),
        axis.title = element_text(size=16,  family = 'Arial', colour = 'black'),
        axis.text = element_text(size=14, family = 'Arial', colour = 'black'),
        legend.position = 'none', 
        legend.text = element_text(size=11, family = 'Arial', colour = 'black'),
        legend.title = element_text(size=13, family = 'Arial', colour = 'black'))

fig1e <- ctdna_cohort |>
  filter(treatment!='Other') |>
  ggplot(aes(x = treatment, y = TF)) +
  geom_violin(aes(fill = factor(treatment, levels = c('PDS','NACT','Other'))), 
              alpha = .8) +
  geom_boxplot(width=.1) +
  scale_fill_manual(values = c("NACT" = "#744700", "PDS" = "#76a5af", 'Other'='gray'))+
  stat_compare_means(label.x.npc = .35, size = 6, label.y.npc = .8,
                     label = '..p..') +
  theme_pubr()+
  labs(x = 'Treatment modality', y = '') +
  theme(axis.text.x = element_text(size=14,  family = 'Arial', colour = 'black'),
      axis.title = element_text(size=16,  family = 'Arial', colour = 'black'),
      axis.text = element_text(size=14, family = 'Arial', colour = 'black'),
      legend.position = 'none', 
      legend.text = element_text(size=11, family = 'Arial', colour = 'black'),
      legend.title = element_text(size=13, family = 'Arial', colour = 'black'))

#svg(paste0(project_dir,'results/figures_Dec25/main/1b_HRD_trtm.svg'), height = 5, width = 11)
ggarrange(
  fig1a, ggarrange(fig1b, fig1d, fig1c, fig1e, ncol = 2, nrow = 2),
  ncol = 2, widths = c(.36,.64)
)
#dev.off()
```

### Figure 1c: Study design: integrating tissue omics data into the analysis
```{r fig1c, echo=FALSE, fig.cap="Figure 1c - Study design", out.width="50%"}
knitr::include_graphics("../../results/figures_Dec25/Study_degsign.png")
```

### Figure 1d: cohort visualization

```{r fig1d, echo=FALSE, fig.cap="Figure 1d - Cohort information", out.width="120%" }
knitr::include_graphics("../../results/figures_Dec25/01_cohort.png")
```

```{r end, echo=FALSE}

```